#!/usr/bin/env python3
"""
üè¢ NICEGOLD ENTERPRISE PROJECTP - ENVIRONMENT MANAGER
‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Environment ‡πÅ‡∏ö‡∏ö Advanced ‡∏û‡∏£‡πâ‡∏≠‡∏° Health Check

üìã Features:
- ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Environment
- ‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Dependencies  
- ‚úÖ ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏° Environment ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
"""

import os
import sys
import subprocess
import json
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Tuple, Optional

class NicegoldEnvironmentManager:
    """‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Environment ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NICEGOLD ProjectP"""
    
    def __init__(self):
        self.project_root = Path("/mnt/data/projects/ProjectP")
        self.env_root = Path("/home/ACER/.cache/nicegold_env")
        self.venv_name = "nicegold_enterprise_env"
        self.venv_path = self.env_root / self.venv_name
        self.activation_script = self.project_root / "activate_nicegold_env.sh"
        
        # Required packages with versions
        self.required_packages = {
            'numpy': '1.26.4',
            'pandas': '2.2.3', 
            'scikit-learn': '1.5.2',
            'tensorflow': '2.17.0',
            'torch': '2.4.1',
            'shap': '0.45.0',
            'optuna': '3.5.0',
            'PyYAML': '6.0.2',
            'matplotlib': '3.5.0',
            'plotly': '5.0.0'
        }
    
    def print_header(self):
        """‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"""
        print("=" * 80)
        print("üè¢ NICEGOLD ENTERPRISE PROJECTP - ENVIRONMENT MANAGER")
        print("=" * 80)
        print()
    
    def check_environment_exists(self) -> bool:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Environment ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
        return self.venv_path.exists() and (self.venv_path / "bin" / "python").exists()
    
    def check_package_installed(self, package_name: str, required_version: Optional[str] = None) -> Tuple[bool, str]:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ package ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"""
        try:
            result = subprocess.run([
                str(self.venv_path / "bin" / "python"), "-c",
                f"import {package_name.replace('-', '_')}; print({package_name.replace('-', '_')}.__version__)"
            ], capture_output=True, text=True, timeout=10)
            
            if result.returncode == 0:
                installed_version = result.stdout.strip()
                if required_version:
                    # Simple version comparison
                    if installed_version.startswith(required_version.split('.')[0]):
                        return True, installed_version
                    else:
                        return False, f"Version mismatch: {installed_version} (required: {required_version})"
                return True, installed_version
            else:
                return False, "Not installed"
        except Exception as e:
            return False, f"Error: {str(e)}"
    
    def get_environment_status(self) -> Dict:
        """‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Environment"""
        status = {
            'timestamp': datetime.now().isoformat(),
            'environment_exists': self.check_environment_exists(),
            'activation_script_exists': self.activation_script.exists(),
            'packages': {},
            'health_score': 0,
            'issues': [],
            'recommendations': []
        }
        
        if not status['environment_exists']:
            status['issues'].append("Virtual environment not found")
            status['recommendations'].append("Run install_isolated_libraries.sh to create environment")
            return status
        
        # Check packages
        total_packages = len(self.required_packages)
        working_packages = 0
        
        for package, version in self.required_packages.items():
            is_installed, details = self.check_package_installed(package, version)
            status['packages'][package] = {
                'installed': is_installed,
                'details': details,
                'required_version': version
            }
            
            if is_installed:
                working_packages += 1
            else:
                status['issues'].append(f"{package}: {details}")
        
        # Calculate health score
        status['health_score'] = int((working_packages / total_packages) * 100)
        
        # Recommendations
        if status['health_score'] < 80:
            status['recommendations'].append("Reinstall environment for better compatibility")
        elif status['health_score'] < 100:
            status['recommendations'].append("Update missing packages")
        
        if not status['activation_script_exists']:
            status['issues'].append("Activation script missing")
            status['recommendations'].append("Recreate activation script")
        
        return status
    
    def create_status_report(self) -> str:
        """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"""
        status = self.get_environment_status()
        
        report = f"""
üè¢ NICEGOLD ENTERPRISE PROJECTP - ENVIRONMENT STATUS REPORT
Generated: {status['timestamp']}

üìä OVERALL HEALTH SCORE: {status['health_score']}%

üîç ENVIRONMENT CHECK:
‚úÖ Environment Exists: {'Yes' if status['environment_exists'] else 'No'}
‚úÖ Activation Script: {'Yes' if status['activation_script_exists'] else 'No'}

üì¶ PACKAGE STATUS:
"""
        
        for package, info in status['packages'].items():
            status_icon = "‚úÖ" if info['installed'] else "‚ùå"
            report += f"{status_icon} {package}: {info['details']}\n"
        
        if status['issues']:
            report += f"\n‚ö†Ô∏è ISSUES FOUND ({len(status['issues'])}):\n"
            for issue in status['issues']:
                report += f"   - {issue}\n"
        
        if status['recommendations']:
            report += f"\nüí° RECOMMENDATIONS:\n"
            for rec in status['recommendations']:
                report += f"   - {rec}\n"
        
        # Health assessment
        if status['health_score'] >= 90:
            report += "\nüéâ EXCELLENT: Environment is production-ready!"
        elif status['health_score'] >= 70:
            report += "\nüëç GOOD: Environment is mostly functional"
        elif status['health_score'] >= 50:
            report += "\n‚ö†Ô∏è FAIR: Environment needs attention"
        else:
            report += "\n‚ùå POOR: Environment requires reinstallation"
        
        return report
    
    def save_status_report(self, filename: str = None) -> str:
        """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"""
        if filename is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"environment_status_{timestamp}.txt"
        
        report_path = self.project_root / filename
        report = self.create_status_report()
        
        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(report)
        
        return str(report_path)
    
    def fix_activation_script(self) -> bool:
        """‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÑ‡∏ü‡∏•‡πå activation script"""
        try:
            script_content = f"""#!/bin/bash
# üè¢ NICEGOLD Enterprise ProjectP - Environment Activation Script
# Activates the isolated Python environment for NICEGOLD ProjectP

VENV_PATH="{self.venv_path}"

if [ ! -d "$VENV_PATH" ]; then
    echo "‚ùå Virtual environment not found at: $VENV_PATH"
    echo "üìã Please run the installation script first: ./install_isolated_libraries.sh"
    exit 1
fi

echo "üöÄ Activating NICEGOLD Enterprise Environment..."
echo "üìç Environment Path: $VENV_PATH"

# Activate the environment
source "$VENV_PATH/bin/activate"

# Set environment variables for optimal performance
export CUDA_VISIBLE_DEVICES='-1'
export TF_CPP_MIN_LOG_LEVEL='3'
export TF_ENABLE_ONEDNN_OPTS='0'
export PYTHONIOENCODING='utf-8'
export TF_XLA_FLAGS='--tf_xla_enable_xla_devices=false'
export XLA_FLAGS='--xla_gpu_cuda_data_dir=""'

echo "‚úÖ Environment activated successfully!"
echo "üéØ You can now run: python ProjectP.py"
echo ""
echo "üìã To deactivate: deactivate"
echo "üîÑ To reactivate: source activate_nicegold_env.sh"
"""
            
            with open(self.activation_script, 'w') as f:
                f.write(script_content)
            
            os.chmod(self.activation_script, 0o755)
            return True
        except Exception as e:
            print(f"‚ùå Failed to fix activation script: {e}")
            return False
    
    def quick_fix(self) -> bool:
        """‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô"""
        print("üîß Running Quick Fix...")
        
        fixed = False
        
        # Fix activation script if missing
        if not self.activation_script.exists():
            print("üîß Fixing activation script...")
            if self.fix_activation_script():
                print("‚úÖ Activation script fixed")
                fixed = True
            else:
                print("‚ùå Failed to fix activation script")
        
        return fixed

def main():
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å"""
    manager = NicegoldEnvironmentManager()
    manager.print_header()
    
    if len(sys.argv) > 1:
        command = sys.argv[1].lower()
        
        if command == "status":
            print(manager.create_status_report())
            
        elif command == "report":
            report_path = manager.save_status_report()
            print(f"üìã Status report saved to: {report_path}")
            
        elif command == "fix":
            if manager.quick_fix():
                print("‚úÖ Quick fix completed")
            else:
                print("‚ùå Quick fix failed")
                
        elif command == "health":
            status = manager.get_environment_status()
            print(f"üè• Environment Health Score: {status['health_score']}%")
            
        else:
            print(f"‚ùå Unknown command: {command}")
            print("Available commands: status, report, fix, health")
    else:
        # Default: show status
        print(manager.create_status_report())

if __name__ == "__main__":
    main()
