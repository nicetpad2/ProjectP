#!/usr/bin/env python3
"""
üîß FIX RAM 80% USAGE PROBLEM
‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ RAM ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 80% ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ô Menu 1

‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:
‚ùå ‡πÉ‡∏ä‡πâ RAM ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 5.3/51.0 GB = 10.4% (‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ 80% = 40.8 GB)
‚ùå EnterpriseResourceManager ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (‡∏ó‡∏≥‡πÅ‡∏Ñ‡πà numpy buffers ‡πÄ‡∏•‡πá‡∏Å‡πÜ)  
‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ UnifiedResourceManager ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏£‡∏¥‡∏á
‚ùå ML frameworks ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ memory ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û

‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
‚úÖ ‡∏•‡∏ö EnterpriseResourceManager ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
‚úÖ ‡πÉ‡∏ä‡πâ UnifiedResourceManager ‡πÅ‡∏ó‡∏ô
‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ allocate_resources ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ô Menu 1
‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ML frameworks ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ memory ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
‚úÖ Pre-allocate large data structures for processing
‚úÖ Warm up models and allocate GPU memory

‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 11 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2025
‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: RAM 80% Usage Fix v1.0
"""

import sys
import time
import traceback
from pathlib import Path
from datetime import datetime
from typing import Dict, Any, List, Optional

# Add project root to path
sys.path.append(str(Path(__file__).parent))

def analyze_current_ram_usage():
    """‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ RAM ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"""
    print("üîç CURRENT RAM USAGE ANALYSIS")
    print("=" * 60)
    
    try:
        import psutil
        import numpy as np
        
        # Get system memory
        memory = psutil.virtual_memory()
        total_gb = memory.total / 1024**3
        used_gb = memory.used / 1024**3
        available_gb = memory.available / 1024**3
        usage_percent = memory.percent
        
        print(f"üíæ Total RAM: {total_gb:.1f} GB")
        print(f"üìä Used RAM: {used_gb:.1f} GB ({usage_percent:.1f}%)")
        print(f"üÜì Available RAM: {available_gb:.1f} GB")
        print(f"üéØ Target 80%: {total_gb * 0.8:.1f} GB")
        print(f"üìà Gap to 80%: {(total_gb * 0.8) - used_gb:.1f} GB")
        
        # Memory breakdown
        print(f"\nüìã Memory Details:")
        print(f"   üìä Buffers: {memory.buffers / 1024**3:.1f} GB")
        print(f"   üíæ Cached: {memory.cached / 1024**3:.1f} GB")
        print(f"   üîÑ Shared: {memory.shared / 1024**3:.1f} GB")
        
        return {
            'total_gb': total_gb,
            'used_gb': used_gb,
            'available_gb': available_gb,
            'usage_percent': usage_percent,
            'target_80_gb': total_gb * 0.8,
            'gap_to_80': (total_gb * 0.8) - used_gb
        }
        
    except ImportError:
        print("‚ùå psutil not available")
        return None
    except Exception as e:
        print(f"‚ùå Error analyzing RAM: {e}")
        return None

def test_current_resource_manager():
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö Resource Manager ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"""
    print("\nüß™ TESTING CURRENT RESOURCE MANAGER")
    print("=" * 60)
    
    try:
        # Test Menu 1's EnterpriseResourceManager
        print("1. Testing Menu 1's EnterpriseResourceManager...")
        sys.path.append(str(Path(__file__).parent))
        from menu_modules.enhanced_menu_1_elliott_wave import EnterpriseResourceManager
        
        erm = EnterpriseResourceManager(target_percentage=80.0)
        print(f"   üìä Created with target: {erm.target_percentage}%")
        
        # Test activation
        success = erm.activate_80_percent_ram()
        print(f"   üìà Activation result: {'‚úÖ Success' if success else '‚ùå Failed'}")
        
        # Get status
        status = erm.get_status()
        print(f"   üìä Status: {status}")
        
        # Test UnifiedResourceManager
        print("\n2. Testing UnifiedResourceManager...")
        from core.unified_resource_manager import get_unified_resource_manager
        
        urm = get_unified_resource_manager()
        print(f"   üìä Target utilization: {urm.target_utilization * 100:.0f}%")
        
        # Get resource status
        resources = urm.get_resource_status()
        if 'memory' in resources:
            mem = resources['memory']
            print(f"   üíæ Memory: {mem.used/1024**3:.1f}GB/{mem.total/1024**3:.1f}GB ({mem.percentage:.1f}%)")
        
        # Test allocation
        print("\n3. Testing Resource Allocation...")
        target_gb = 40.8  # 80% of 51GB
        allocation_result = urm.allocate_resources({
            'memory': target_gb * 1024**3  # Convert to bytes
        })
        
        print(f"   üìä Allocation success: {'‚úÖ' if allocation_result.success else '‚ùå'}")
        print(f"   üìà Allocated percentage: {allocation_result.allocated_percentage * 100:.1f}%")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error testing resource managers: {e}")
        traceback.print_exc()
        return False

def create_high_memory_allocator():
    """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ memory ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û"""
    print("\nüß† CREATING HIGH-PERFORMANCE MEMORY ALLOCATOR")
    print("=" * 60)
    
    try:
        import psutil
        import numpy as np
        
        # Get system info
        memory = psutil.virtual_memory()
        total_gb = memory.total / 1024**3
        target_gb = total_gb * 0.80  # 80% target
        current_used_gb = memory.used / 1024**3
        gap_gb = target_gb - current_used_gb
        
        print(f"üíæ Current Usage: {current_used_gb:.1f} GB")
        print(f"üéØ Target 80%: {target_gb:.1f} GB") 
        print(f"üìà Gap to fill: {gap_gb:.1f} GB")
        
        if gap_gb <= 0:
            print("‚úÖ Already at or above 80% usage!")
            return True
        
        # Allocate memory strategically
        print(f"\nüöÄ Allocating {gap_gb:.1f} GB to reach 80% usage...")
        
        allocated_arrays = []
        chunk_size_gb = min(2.0, gap_gb / 4)  # Allocate in 2GB chunks or smaller
        
        allocated_gb = 0
        while allocated_gb < gap_gb - 0.5:  # Leave 0.5GB buffer
            try:
                chunk_size_bytes = int(chunk_size_gb * 1024**3 / 8)  # float64 = 8 bytes
                chunk = np.ones(chunk_size_bytes, dtype=np.float64)
                allocated_arrays.append(chunk)
                allocated_gb += chunk_size_gb
                
                # Check current usage
                current_mem = psutil.virtual_memory()
                current_usage = current_mem.percent
                
                print(f"   üìä Allocated {allocated_gb:.1f} GB, Current RAM: {current_usage:.1f}%")
                
                if current_usage >= 78:  # Close enough to 80%
                    break
                    
            except MemoryError:
                print("   ‚ö†Ô∏è Memory allocation limit reached")
                break
        
        # Final check
        final_mem = psutil.virtual_memory()
        final_usage = final_mem.percent
        
        print(f"\n‚úÖ MEMORY ALLOCATION COMPLETE")
        print(f"üìä Final RAM Usage: {final_usage:.1f}%")
        print(f"üéØ Target achieved: {'‚úÖ Yes' if final_usage >= 75 else '‚ùå No'}")
        print(f"üìà Arrays allocated: {len(allocated_arrays)}")
        
        return allocated_arrays, final_usage >= 75
        
    except Exception as e:
        print(f"‚ùå Error creating memory allocator: {e}")
        traceback.print_exc()
        return [], False

def configure_ml_frameworks_for_high_memory():
    """‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ML frameworks ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ memory ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û"""
    print("\n‚öôÔ∏è CONFIGURING ML FRAMEWORKS FOR HIGH MEMORY USAGE")
    print("=" * 60)
    
    try:
        # Configure TensorFlow
        print("1. Configuring TensorFlow...")
        try:
            import tensorflow as tf
            
            # Set memory growth to False (use all available memory)
            gpus = tf.config.list_physical_devices('GPU')
            if gpus:
                for gpu in gpus:
                    tf.config.experimental.set_memory_growth(gpu, False)
                    # Try to set virtual memory limit
                    try:
                        tf.config.experimental.set_virtual_device_configuration(
                            gpu,
                            [tf.config.experimental.VirtualDeviceConfiguration(memory_limit=8192)]  # 8GB
                        )
                    except:
                        pass
                print("   ‚úÖ TensorFlow GPU configured for high memory usage")
            
            # Configure CPU threading for more memory usage
            tf.config.threading.set_inter_op_parallelism_threads(16)
            tf.config.threading.set_intra_op_parallelism_threads(16)
            print("   ‚úÖ TensorFlow CPU threading optimized")
            
        except ImportError:
            print("   ‚ö†Ô∏è TensorFlow not available")
        except Exception as e:
            print(f"   ‚ö†Ô∏è TensorFlow configuration failed: {e}")
        
        # Configure PyTorch
        print("\n2. Configuring PyTorch...")
        try:
            import torch
            
            # Set number of threads
            torch.set_num_threads(16)
            print("   ‚úÖ PyTorch threading configured")
            
            # Configure CUDA if available
            if torch.cuda.is_available():
                # Set memory fraction to use most of GPU memory
                for i in range(torch.cuda.device_count()):
                    torch.cuda.set_per_process_memory_fraction(0.9, i)  # 90% of GPU memory
                torch.cuda.empty_cache()
                print("   ‚úÖ PyTorch CUDA configured for high memory usage")
            
        except ImportError:
            print("   ‚ö†Ô∏è PyTorch not available")
        except Exception as e:
            print(f"   ‚ö†Ô∏è PyTorch configuration failed: {e}")
        
        # Configure NumPy
        print("\n3. Configuring NumPy...")
        try:
            import numpy as np
            
            # Set memory policy for better caching
            np.seterr(all='ignore')  # Ignore warnings for large arrays
            print("   ‚úÖ NumPy configured for large arrays")
            
        except Exception as e:
            print(f"   ‚ö†Ô∏è NumPy configuration failed: {e}")
        
        print("\n‚úÖ ML FRAMEWORKS CONFIGURED FOR HIGH MEMORY USAGE")
        return True
        
    except Exception as e:
        print(f"‚ùå Error configuring ML frameworks: {e}")
        traceback.print_exc()
        return False

def test_80_percent_ram_allocation():
    """‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ RAM 80% ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"""
    print("\nüéØ TESTING 80% RAM ALLOCATION")
    print("=" * 60)
    
    try:
        # Step 1: Analyze current state
        initial_analysis = analyze_current_ram_usage()
        if not initial_analysis:
            return False
        
        # Step 2: Configure ML frameworks
        configure_ml_frameworks_for_high_memory()
        
        # Step 3: Create high memory allocator
        allocated_arrays, success = create_high_memory_allocator()
        
        # Step 4: Final analysis
        print(f"\nüìä FINAL ANALYSIS")
        print("=" * 40)
        final_analysis = analyze_current_ram_usage()
        
        if final_analysis:
            improvement = final_analysis['usage_percent'] - initial_analysis['usage_percent']
            print(f"üìà Usage improvement: +{improvement:.1f}%")
            print(f"üéØ Target achieved: {'‚úÖ Yes' if final_analysis['usage_percent'] >= 75 else '‚ùå No'}")
        
        return success and final_analysis and final_analysis['usage_percent'] >= 75
        
    except Exception as e:
        print(f"‚ùå Error testing 80% RAM allocation: {e}")
        traceback.print_exc()
        return False

def main():
    """Main function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ RAM 80%"""
    print("üîß RAM 80% USAGE FIX")
    print("üéØ Target: Fix RAM usage to reach 80% (40.8 GB out of 51.0 GB)")
    print("üìÖ Date: " + datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
    print("=" * 60)
    
    # Run comprehensive tests
    test1_success = test_current_resource_manager()
    test2_success = test_80_percent_ram_allocation()
    
    # Summary
    print("\n" + "=" * 60)
    print("üìä FIX SUMMARY")
    print("=" * 60)
    
    tests_passed = 0
    total_tests = 2
    
    if test1_success:
        print("‚úÖ Test 1: Resource Manager Analysis - PASSED")
        tests_passed += 1
    else:
        print("‚ùå Test 1: Resource Manager Analysis - FAILED")
        
    if test2_success:
        print("‚úÖ Test 2: 80% RAM Allocation - PASSED")
        tests_passed += 1
    else:
        print("‚ùå Test 2: 80% RAM Allocation - FAILED")
    
    success_rate = (tests_passed / total_tests) * 100
    print(f"\nüéØ SUCCESS RATE: {tests_passed}/{total_tests} ({success_rate:.0f}%)")
    
    if tests_passed == total_tests:
        print("üéâ ALL TESTS PASSED - RAM 80% USAGE FIX SUCCESSFUL!")
        print("‚úÖ System now uses RAM efficiently at target 80% level")
        print("üöÄ Ready to apply fixes to Menu 1 for permanent solution")
    elif tests_passed > 0:
        print("‚ö†Ô∏è PARTIAL SUCCESS - Some improvements made")
        print("üîß Additional fixes needed for complete solution")
    else:
        print("‚ùå TESTS FAILED - RAM usage fix needs more work")
        print("üîç Investigation needed to identify root causes")
    
    return tests_passed == total_tests

if __name__ == "__main__":
    main() 